{
    "openapi": "3.0.3",
    "info": {
        "title": "API de Análisis Forense de Audio (Multi-Nivel)",
        "description": "API para el análisis forense de archivos de audio. Permite transcripción, detección de hablantes, análisis de autenticidad y detección de manipulación (Deepfakes/Edición). Utiliza procesamiento asíncrono con polling de estado.",
        "version": "1.0.0",
        "contact": {
            "name": "Equipo de Ingeniería"
        }
    },
    "servers": [
        {
            "url": "https://mdkswlgcqsmgfmcuorxq.supabase.co/functions/v1/audio-analysis",
            "description": "Servidor de Producción (Supabase Edge Function)"
        }
    ],
    "components": {
        "securitySchemes": {
            "bearerAuth": {
                "type": "http",
                "scheme": "bearer",
                "bearerFormat": "JWT",
                "description": "Token de autenticación de Supabase (User Auth)"
            }
        },
        "schemas": {
            "SubmitRequest": {
                "type": "object",
                "required": [
                    "url",
                    "type"
                ],
                "properties": {
                    "url": {
                        "type": "string",
                        "format": "uri",
                        "description": "URL pública directa del archivo de audio a analizar.",
                        "example": "https://bucket.s3.amazonaws.com/audio_caso_01.wav"
                    },
                    "type": {
                        "type": "string",
                        "enum": [
                            "audio"
                        ],
                        "default": "audio",
                        "description": "Tipo de análisis. Debe ser 'audio' para este endpoint."
                    }
                }
            },
            "SubmitResponse": {
                "type": "object",
                "properties": {
                    "job_id": {
                        "type": "string",
                        "format": "uuid",
                        "description": "Identificador único del trabajo para realizar seguimiento (polling).",
                        "example": "b2c3d4e5-f6g7-8901-2345-678901bcdefg"
                    },
                    "status": {
                        "type": "string",
                        "example": "pending",
                        "description": "Estado inicial del trabajo."
                    }
                }
            },
            "TranscriptionSegment": {
                "type": "object",
                "description": "Segmento de transcripción con timestamps.",
                "properties": {
                    "start_time": {
                        "type": "number",
                        "format": "float",
                        "description": "Tiempo de inicio del segmento en segundos.",
                        "example": 0.0
                    },
                    "end_time": {
                        "type": "number",
                        "format": "float",
                        "description": "Tiempo de fin del segmento en segundos.",
                        "example": 5.5
                    },
                    "text": {
                        "type": "string",
                        "description": "Texto transcrito del segmento.",
                        "example": "Buenos días, bienvenidos al programa."
                    },
                    "speaker": {
                        "type": "string",
                        "nullable": true,
                        "description": "Identificador del hablante (si se detectó diarización).",
                        "example": "Speaker_1"
                    }
                }
            },
            "Transcription": {
                "type": "object",
                "description": "Transcripción completa del audio.",
                "properties": {
                    "text": {
                        "type": "string",
                        "description": "Texto completo transcrito.",
                        "example": "Buenos días, bienvenidos al programa..."
                    },
                    "language": {
                        "type": "string",
                        "description": "Idioma detectado (ISO 639-1).",
                        "example": "es"
                    },
                    "confidence": {
                        "type": "number",
                        "format": "float",
                        "minimum": 0,
                        "maximum": 1,
                        "description": "Confianza global de la transcripción (0-1).",
                        "example": 0.95
                    },
                    "segments": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/TranscriptionSegment"
                        }
                    }
                }
            },
            "SpeakerAnalysis": {
                "type": "object",
                "description": "Análisis de hablantes detectados en el audio.",
                "properties": {
                    "num_speakers": {
                        "type": "integer",
                        "description": "Número de hablantes detectados.",
                        "example": 2
                    },
                    "speakers": {
                        "type": "array",
                        "items": {
                            "type": "object",
                            "properties": {
                                "id": {
                                    "type": "string",
                                    "description": "Identificador del hablante.",
                                    "example": "Speaker_1"
                                },
                                "segments": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "properties": {
                                            "start_time": {
                                                "type": "number"
                                            },
                                            "end_time": {
                                                "type": "number"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            },
            "AudioForensics": {
                "type": "object",
                "description": "Análisis forense de autenticidad del audio.",
                "properties": {
                    "authenticity_score": {
                        "type": "number",
                        "format": "float",
                        "minimum": 0,
                        "maximum": 1,
                        "description": "Puntuación de autenticidad (0 = manipulado, 1 = auténtico).",
                        "example": 0.85
                    },
                    "manipulation_detected": {
                        "type": "boolean",
                        "description": "Indica si se detectó alguna manipulación.",
                        "example": false
                    },
                    "anomalies": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "Lista de anomalías detectadas.",
                        "example": [
                            "Corte abrupto detectado en 45.2s",
                            "Posible splicing en 120.5s"
                        ]
                    }
                }
            },
            "SentimentAnalysis": {
                "type": "object",
                "description": "Análisis de sentimiento del contenido de audio.",
                "properties": {
                    "overall_sentiment": {
                        "type": "string",
                        "enum": [
                            "positive",
                            "negative",
                            "neutral"
                        ],
                        "description": "Sentimiento predominante.",
                        "example": "neutral"
                    },
                    "confidence": {
                        "type": "number",
                        "format": "float",
                        "minimum": 0,
                        "maximum": 1,
                        "description": "Confianza del análisis de sentimiento.",
                        "example": 0.78
                    }
                }
            },
            "Verdict": {
                "type": "object",
                "description": "Veredicto final del análisis.",
                "properties": {
                    "conclusion": {
                        "type": "string",
                        "description": "Resumen ejecutivo del veredicto.",
                        "example": "El audio no muestra signos significativos de manipulación."
                    },
                    "confidence": {
                        "type": "number",
                        "format": "float",
                        "minimum": 0,
                        "maximum": 1,
                        "description": "Nivel de confianza del veredicto.",
                        "example": 0.92
                    },
                    "risk_level": {
                        "type": "string",
                        "enum": [
                            "low",
                            "medium",
                            "high",
                            "critical"
                        ],
                        "description": "Nivel de riesgo asociado.",
                        "example": "low"
                    }
                }
            },
            "AudioHumanReport": {
                "type": "object",
                "description": "Informe legible generado por IA basado en el análisis técnico.",
                "properties": {
                    "summary": {
                        "type": "string",
                        "description": "Resumen ejecutivo del análisis.",
                        "example": "El audio de 2 minutos contiene una conversación entre 2 personas sin signos de manipulación detectados."
                    },
                    "transcription": {
                        "$ref": "#/components/schemas/Transcription"
                    },
                    "speaker_analysis": {
                        "$ref": "#/components/schemas/SpeakerAnalysis"
                    },
                    "audio_forensics": {
                        "$ref": "#/components/schemas/AudioForensics"
                    },
                    "sentiment_analysis": {
                        "$ref": "#/components/schemas/SentimentAnalysis"
                    },
                    "verdict": {
                        "$ref": "#/components/schemas/Verdict"
                    }
                }
            },
            "AudioFileInfo": {
                "type": "object",
                "description": "Información técnica del archivo de audio.",
                "properties": {
                    "name": {
                        "type": "string",
                        "description": "Nombre original del archivo.",
                        "example": "grabacion_reunion.wav"
                    },
                    "size_bytes": {
                        "type": "integer",
                        "description": "Tamaño del archivo en bytes.",
                        "example": 5242880
                    },
                    "mime_type": {
                        "type": "string",
                        "description": "Tipo MIME del archivo.",
                        "example": "audio/wav"
                    },
                    "duration_seconds": {
                        "type": "number",
                        "format": "float",
                        "description": "Duración del audio en segundos.",
                        "example": 124.5
                    },
                    "sample_rate": {
                        "type": "integer",
                        "description": "Frecuencia de muestreo en Hz.",
                        "example": 44100
                    },
                    "channels": {
                        "type": "integer",
                        "description": "Número de canales (1=mono, 2=stereo).",
                        "example": 2
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time",
                        "description": "Fecha de procesamiento."
                    }
                }
            },
            "AudioRawResultsSummary": {
                "type": "object",
                "description": "Resumen de datos técnicos crudos del análisis.",
                "properties": {
                    "duration_seconds": {
                        "type": "number"
                    },
                    "sample_rate": {
                        "type": "integer"
                    },
                    "channels": {
                        "type": "integer"
                    },
                    "format": {
                        "type": "string"
                    },
                    "file_size_bytes": {
                        "type": "integer"
                    },
                    "spectral_analysis": {
                        "type": "object",
                        "additionalProperties": true,
                        "description": "Datos de análisis espectral."
                    },
                    "waveform_data": {
                        "type": "array",
                        "items": {
                            "type": "number"
                        },
                        "description": "Datos de forma de onda muestreados."
                    }
                }
            },
            "ChainOfCustodyEvent": {
                "type": "object",
                "description": "Evento en la cadena de custodia del archivo.",
                "properties": {
                    "timestamp": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "action": {
                        "type": "string"
                    },
                    "actor": {
                        "type": "string"
                    },
                    "details": {
                        "type": "string"
                    },
                    "hash": {
                        "type": "string",
                        "nullable": true
                    }
                }
            },
            "AudioAnalysisResult": {
                "type": "object",
                "description": "Objeto de respuesta completo del análisis de audio.",
                "properties": {
                    "type": {
                        "type": "string",
                        "enum": [
                            "audio_analysis"
                        ],
                        "description": "Tipo de resultado para routing en frontend."
                    },
                    "meta": {
                        "type": "object",
                        "properties": {
                            "job_id": {
                                "type": "string",
                                "format": "uuid"
                            },
                            "timestamp": {
                                "type": "string",
                                "format": "date-time"
                            },
                            "status": {
                                "type": "string",
                                "enum": [
                                    "pending",
                                    "processing",
                                    "completed",
                                    "failed"
                                ]
                            },
                            "current_step": {
                                "type": "string",
                                "nullable": true
                            }
                        }
                    },
                    "human_report": {
                        "$ref": "#/components/schemas/AudioHumanReport"
                    },
                    "raw_results_summary": {
                        "$ref": "#/components/schemas/AudioRawResultsSummary"
                    },
                    "file_info": {
                        "$ref": "#/components/schemas/AudioFileInfo"
                    },
                    "chain_of_custody": {
                        "type": "array",
                        "items": {
                            "$ref": "#/components/schemas/ChainOfCustodyEvent"
                        }
                    },
                    "recommendations": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "Lista de recomendaciones para el usuario."
                    }
                }
            },
            "JobStatusResponse": {
                "type": "object",
                "properties": {
                    "id": {
                        "type": "string",
                        "format": "uuid"
                    },
                    "status": {
                        "type": "string",
                        "enum": [
                            "pending",
                            "processing",
                            "completed",
                            "failed"
                        ],
                        "description": "Estado actual del proceso."
                    },
                    "current_step": {
                        "type": "string",
                        "description": "Descripción legible del paso actual.",
                        "example": "Transcribing audio..."
                    },
                    "error": {
                        "type": "object",
                        "nullable": true,
                        "properties": {
                            "message": {
                                "type": "string"
                            }
                        }
                    },
                    "result": {
                        "$ref": "#/components/schemas/AudioAnalysisResult",
                        "description": "Objeto de resultados, presente solo cuando status es 'completed'."
                    },
                    "created_at": {
                        "type": "string",
                        "format": "date-time"
                    },
                    "completed_at": {
                        "type": "string",
                        "format": "date-time",
                        "nullable": true
                    }
                }
            }
        }
    },
    "paths": {
        "/submit": {
            "post": {
                "summary": "Iniciar análisis de audio",
                "description": "Envía una URL de archivo de audio para ser procesada. El sistema descargará el audio, ejecutará análisis de transcripción, diarización, y verificación forense, generando un informe detallado.",
                "security": [
                    {
                        "bearerAuth": []
                    }
                ],
                "requestBody": {
                    "required": true,
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/SubmitRequest"
                            }
                        }
                    }
                },
                "responses": {
                    "202": {
                        "description": "Solicitud aceptada. Se devuelve un Job ID para consultar el estado.",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/SubmitResponse"
                                }
                            }
                        }
                    },
                    "401": {
                        "description": "No autorizado. Token inválido o expirado."
                    },
                    "400": {
                        "description": "Solicitud inválida. URL de audio requerida."
                    },
                    "500": {
                        "description": "Error interno del servidor."
                    }
                }
            }
        },
        "/status/{job_id}": {
            "get": {
                "summary": "Consultar estado y resultados",
                "description": "Permite verificar el progreso de un análisis de audio. Si el estado es 'completed', devuelve el informe completo.",
                "security": [
                    {
                        "bearerAuth": []
                    }
                ],
                "parameters": [
                    {
                        "name": "job_id",
                        "in": "path",
                        "required": true,
                        "schema": {
                            "type": "string",
                            "format": "uuid"
                        },
                        "description": "El ID del trabajo recibido en la respuesta de /submit"
                    }
                ],
                "responses": {
                    "200": {
                        "description": "Estado del trabajo y resultados (si está completo).",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/JobStatusResponse"
                                }
                            }
                        }
                    },
                    "404": {
                        "description": "Trabajo no encontrado."
                    }
                }
            }
        }
    }
}