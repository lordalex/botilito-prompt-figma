{
  "openapi": "3.0.0",
  "info": {
    "title": "Botilito Audio Orchestrator",
    "version": "1.0.0",
    "description": "Public gateway for audio analysis. Features SHA-256 deduplication, caching, and AI-generated forensic reports."
  },
  "servers": [
    {
      "url": "https://mdkswlgcqsmgfmcuorxq.supabase.co/functions/v1/audio-analysis",
      "description": "Production Edge Function"
    }
  ],
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase Auth Token (User or Anon)"
      }
    },
    "schemas": {
      "AnalysisResult": {
        "type": "object",
        "description": "The finalized document containing all intelligence.",
        "properties": {
          "title": { "type": "string", "example": "Análisis de Audio: interview_clip.wav" },
          "content": { "type": "string", "description": "Human-readable summary generated by Gemini." },
          "transcription": { "type": "string", "description": "Full Speech-to-Text output." },
          "metadata": {
            "type": "object",
            "properties": {
              "type": { "type": "string", "example": "audio" },
              "duration": { "type": "number", "example": 45.2 },
              "engine_job_id": { "type": "string", "format": "uuid" },
              "audio_url": { "type": "string", "format": "uri", "description": "Permanent link to original audio in R2" },
              "analysis": {
                "type": "object",
                "description": "Structured forensic data (from prompts.json schema)",
                "properties": {
                  "content": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "example": "Speech" },
                      "structure_notes": { "type": "string" }
                    }
                  },
                  "forensics": {
                    "type": "object",
                    "properties": {
                      "is_synthetic": { "type": "boolean" },
                      "confidence_score": { "type": "number" },
                      "manipulation_type": { "type": "string", "enum": ["Ninguna", "Clonación", "Edición"] },
                      "explanation": { "type": "string" }
                    }
                  }
                }
              },
              "assets": {
                "type": "object",
                "properties": {
                  "report_html": { "type": "string", "format": "uri" },
                  "spectrogram": { "type": "string", "format": "uri" }
                }
              }
            }
          }
        }
      }
    }
  },
  "security": [{ "BearerAuth": [] }],
  "paths": {
    "/submit": {
      "post": {
        "summary": "Submit Audio for Analysis",
        "description": "Checks document cache by hash. If new, submits to Python Engine.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "url": { "type": "string", "example": "https://example.com/audio.mp3" },
                  "audio_base64": { "type": "string", "description": "Data URI format supported" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Cached Result Found",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": { "type": "string", "example": "completed" },
                    "cached": { "type": "boolean", "example": true },
                    "result": { "$ref": "#/components/schemas/AnalysisResult" }
                  }
                }
              }
            }
          },
          "202": {
            "description": "Processing Started",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "job_id": { "type": "string", "format": "uuid" },
                    "status": { "type": "string", "example": "processing" },
                    "hash": { "type": "string", "example": "a1b2c3..." }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/status/{id}": {
      "get": {
        "summary": "Get Status or Result",
        "description": "Pass a Job UUID or File Hash. If engine finished, triggers AI finalization.",
        "parameters": [{ "name": "id", "in": "path", "required": true, "schema": { "type": "string" } }],
        "responses": {
          "200": {
            "description": "Current Status or Final Result",
            "content": {
              "application/json": {
                "schema": {
                  "oneOf": [
                    {
                      "type": "object",
                      "properties": {
                        "status": { "type": "string", "example": "completed" },
                        "result": { "$ref": "#/components/schemas/AnalysisResult" }
                      }
                    },
                    {
                      "type": "object",
                      "properties": {
                        "job_id": { "type": "string" },
                        "status": { "type": "string", "example": "processing" }
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    }
  }
}
