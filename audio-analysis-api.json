{
  "openapi": "3.0.0",
  "info": {
    "title": "Botilito Audio Orchestrator API",
    "version": "1.1.0",
    "description": "Public API for the Botilito Audio Forensics system. Handles authentication, caching, file processing via Python engine, and AI narrative generation via Gemini."
  },
  "servers": [
    {
      "url": "https://[PROJECT_REF].supabase.co/functions/v1/audio-analysis",
      "description": "Production Edge Function"
    }
  ],
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase Access Token. Optional for some deployments, required if Row Level Security is active."
      }
    },
    "schemas": {
      "SubmitRequest": {
        "type": "object",
        "description": "Payload to start an analysis. Requires either `url` or `audio_base64`.",
        "properties": {
          "url": {
            "type": "string",
            "format": "uri",
            "example": "https://example.com/suspicious_audio.mp3",
            "description": "Publicly accessible URL to the audio file."
          },
          "audio_base64": {
            "type": "string",
            "example": "data:audio/mp3;base64,SUQzBAAAAA...",
            "description": "Base64 encoded string of the file. Supports Data URI prefix."
          },
          "use_cache": {
            "type": "boolean",
            "default": true,
            "example": false,
            "description": "If true (default), returns existing results for the same file hash instantly. If false, forces a fresh re-analysis."
          }
        }
      },
      "SubmitResponse": {
        "type": "object",
        "properties": {
          "job_id": {
            "type": "string",
            "format": "uuid",
            "description": "Internal UUID to track the job status."
          },
          "status": {
            "type": "string",
            "enum": ["processing", "completed"],
            "description": "Current state. 'completed' means it was found in cache."
          },
          "hash": {
            "type": "string",
            "description": "SHA-256 fingerprint of the file."
          },
          "cached": {
            "type": "boolean",
            "description": "True if the result came from the DB cache."
          },
          "result": {
            "$ref": "#/components/schemas/AnalysisDocument",
            "description": "Full analysis result (only present if cached=true)."
          }
        }
      },
      "AnalysisDocument": {
        "type": "object",
        "properties": {
          "title": { "type": "string", "example": "An√°lisis de Audio (120s)" },
          "content": { "type": "string", "description": "AI-generated human-readable summary of the findings." },
          "transcription": { "type": "string", "description": "Full Speech-to-Text transcript of the audio." },
          "metadata": {
            "type": "object",
            "properties": {
              "type": { "type": "string", "example": "audio" },
              "duration": { "type": "number", "example": 120.5 },
              "audio_url": { "type": "string", "description": "Permanent R2 Cloudflare URL for the source file." },
              "analysis": {
                "type": "object",
                "properties": {
                  "content": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "example": "Speech" },
                      "structure_notes": { "type": "string" }
                    }
                  },
                  "quality": {
                    "type": "object",
                    "properties": {
                      "environment": { "type": "string", "example": "Studio" },
                      "anomalies_detected": { "type": "string" }
                    }
                  },
                  "forensics": {
                    "type": "object",
                    "properties": {
                      "is_synthetic": { "type": "boolean" },
                      "confidence_score": { "type": "number", "description": "0-100 probability of manipulation." },
                      "manipulation_type": { "type": "string" },
                      "explanation": { "type": "string" }
                    }
                  },
                  "anomalies": {
                    "type": "array",
                    "items": { "type": "string" },
                    "description": "List of audio anomalies detected during listening (e.g. '00:12 - glitch')."
                  }
                }
              },
              "assets": {
                "type": "object",
                "description": "Direct links to generated evidence files in R2.",
                "properties": {
                  "report": { "type": "string", "format": "uri" },
                  "spectrogram": { "type": "string", "format": "uri" },
                  "raw_json": { "type": "string", "format": "uri" }
                }
              }
            }
          }
        }
      }
    }
  },
  "security": [{ "BearerAuth": [] }],
  "paths": {
    "/submit": {
      "post": {
        "summary": "Submit Audio",
        "description": "Uploads audio for forensic analysis. Calculates hash on the fly. If `use_cache` is true and hash exists, returns immediately.",
        "requestBody": {
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SubmitRequest" } } }
        },
        "responses": {
          "200": { "description": "Cached Result Found", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SubmitResponse" } } } },
          "202": { "description": "Job Started (Processing)", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SubmitResponse" } } } },
          "400": { "description": "Invalid Input / Missing Audio" },
          "401": { "description": "Unauthorized" }
        }
      }
    },
    "/status/{id}": {
      "get": {
        "summary": "Get Status",
        "description": "Checks status by Job UUID or File Hash. If the backend engine is finished, this endpoint triggers the AI Finalization step before returning.",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" },
            "description": "The Job UUID (returned by submit) or the SHA-256 Hash of the file."
          }
        ],
        "responses": {
          "200": {
            "description": "Status or Result",
            "content": {
              "application/json": {
                "schema": {
                  "oneOf": [
                    { "$ref": "#/components/schemas/AnalysisDocument" },
                    {
                      "type": "object",
                      "properties": {
                        "job_id": { "type": "string" },
                        "status": { "type": "string", "example": "processing" },
                        "hash": { "type": "string" }
                      }
                    }
                  ]
                }
              }
            }
          },
          "404": { "description": "Job Not Found" }
        }
      }
    }
  }
}