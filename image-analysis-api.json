{
  "openapi": "3.0.3",
  "info": {
    "title": "Sistema Forense de Detección Multimodal (Botilito v3)",
    "version": "3.0.0",
    "description": "Esta especificación define la interfaz para el motor de detección de falsificaciones de Botilito. El sistema utiliza una arquitectura asíncrona avanzada que combina heurísticas clásicas (ELA, Ruido, Ghosting), análisis temporal (Vector Flow) y validación de metadatos binarios. Los resultados se entregan de forma polimórfica para permitir representaciones visuales ricas en el cliente.",
    "contact": {
      "name": "Soporte Técnico Forense",
      "url": "https://botilito.lordalexand.dev"
    }
  },
  "servers": [
    {
      "url": "https://mdkswlgcqsmgfmcuorxq.supabase.co/functions/v1/image-analysis",
      "description": "Puerta de enlace (Edge Function) de Producción"
    }
  ],
  "paths": {
    "/submit": {
      "post": {
        "summary": "Iniciar análisis de archivo",
        "description": "Recibe un archivo multimedia y encola una tarea de análisis en el backend de Python. El sistema utiliza 'magic bytes' para distinguir entre imágenes (JPEG/PNG) y videos (MP4/MOV). Si es video, se activa el motor de flujo vectorial y el muestreo aleatorio adaptativo.",
        "operationId": "submitForAnalysis",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "description": "Contenedor del archivo a analizar.",
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/SubmissionRequest" }
            }
          }
        },
        "responses": {
          "202": {
            "description": "Trabajo aceptado correctamente.",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/SubmissionResponse" }
              }
            }
          },
          "401": { "description": "No se proporcionó un token JWT válido de Supabase." },
          "413": { "description": "El tamaño del Base64 excede el límite operativo de 50MB." }
        }
      }
    },
    "/status/{job_id}": {
      "get": {
        "summary": "Sincronizar y obtener resultados",
        "description": "Endpoint de consulta de estado. Si el motor ha finalizado, este endpoint realiza una 'sincronización perezosa' (Lazy Sync) moviendo los resultados del backend de Python a la base de datos de Supabase antes de entregarlos.",
        "operationId": "getJobStatus",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          {
            "name": "job_id",
            "in": "path",
            "required": true,
            "description": "UUID único del trabajo generado en la petición /submit.",
            "schema": { "type": "string", "format": "uuid", "example": "73a3dd2e-ba58-4932-91f0-357bbbd84332" }
          }
        ],
        "responses": {
          "200": {
            "description": "Respuesta con el estado y los datos forenses detallados.",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/JobStatusResponse" }
              }
            }
          },
          "404": { "description": "El ID de trabajo no existe o ha expirado." }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Token de autenticación de usuario de Supabase."
      }
    },
    "schemas": {
      "SubmissionRequest": {
        "type": "object",
        "required": ["image_base64"],
        "properties": {
          "image_base64": {
            "type": "string",
            "description": "Cadena codificada en Base64 del archivo (Imagen o Video). Se recomienda enviar el prefijo de tipo MIME (ej: data:image/jpeg;base64,...).",
            "example": "data:image/jpeg;base64,/9j/4AAQSkZJRg..."
          }
        }
      },
      "SubmissionResponse": {
        "type": "object",
        "properties": {
          "job_id": {
            "type": "string",
            "format": "uuid",
            "description": "Identificador interno para seguimiento en Supabase.",
            "example": "331c6f7e-2bbb-4a16-bd86-ccbbebc5a663"
          },
          "status": {
            "type": "string",
            "description": "Estado inicial del trabajo.",
            "example": "processing"
          }
        }
      },
      "JobStatusResponse": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "status": {
            "type": "string",
            "enum": ["pending", "processing", "completed", "failed"],
            "description": "Ciclo de vida del trabajo. 'completed' indica que el objeto 'result' está disponible.",
            "example": "completed"
          },
          "result": { "$ref": "#/components/schemas/AnalysisResult" },
          "error": {
            "type": "string",
            "nullable": true,
            "description": "Si el status es 'failed', contiene la traza técnica del error.",
            "example": "Error en extracción de fotogramas via FFmpeg."
          }
        }
      },
      "AnalysisResult": {
        "type": "object",
        "description": "Contenedor de resultados globales y segmentados por tiempo.",
        "properties": {
          "summary": {
            "type": "object",
            "properties": {
              "global_score": {
                "type": "number",
                "description": "Puntaje de sospecha ponderado (0.0 a 1.0).",
                "example": 0.82
              },
              "global_verdict": {
                "type": "string",
                "enum": ["CLEAN", "SUSPICIOUS", "TAMPERED"],
                "description": "Evaluación textual basada en los umbrales de los algoritmos.",
                "example": "TAMPERED"
              }
            }
          },
          "details": {
            "type": "array",
            "description": "Lista de análisis realizados. En imágenes es un array de 1 elemento. En videos varía según la duración (muestreo dinámico).",
            "items": { "$ref": "#/components/schemas/FrameAnalysis" }
          }
        }
      },
      "FrameAnalysis": {
        "type": "object",
        "description": "Análisis forense de un cuadro específico de la fuente original.",
        "properties": {
          "frame_index": {
            "type": "integer",
            "description": "Posición del cuadro en la secuencia original (0 para imágenes estáticas).",
            "example": 450
          },
          "original_frame": {
            "type": "string",
            "description": "Captura Base64 del cuadro original analizado. Útil para comparar con el heatmap.",
            "example": "iVBORw0KGgoAAAANSUhEUgAA..."
          },
          "max_score": {
            "type": "number",
            "description": "La mayor probabilidad de manipulación encontrada entre todos los insights de este cuadro.",
            "example": 0.75
          },
          "insights": {
            "type": "array",
            "description": "Colección polimórfica de hallazgos para este cuadro.",
            "items": { "$ref": "#/components/schemas/Insight" }
          }
        }
      },
      "Insight": {
        "type": "object",
        "required": ["algo", "type", "value", "description"],
        "description": "Hallazgo individual generado por un motor específico. El campo 'type' define cómo debe interpretarse la respuesta.",
        "properties": {
          "algo": {
            "type": "string",
            "description": "Nombre técnico del motor de análisis (ej: ELA, SLIC, CLONE, MOTION_FLOW).",
            "example": "ELA"
          },
          "type": {
            "type": "string",
            "enum": ["classic_algo", "ai_model", "metadata"],
            "description": "Categoría de análisis: algoritmos de visión, redes neuronales o datos de cabecera.",
            "example": "classic_algo"
          },
          "value": {
            "oneOf": [
              { "type": "number", "description": "Confianza (0-1)." },
              { "type": "string", "description": "Resumen cualitativo." }
            ],
            "example": 0.94
          },
          "description": {
            "type": "string",
            "description": "Explicación en español sobre qué detecta este motor y por qué es relevante el valor obtenido.",
            "example": "Detecta áreas con inconsistencia en la compresión JPEG, sugiriendo que el objeto fue insertado posteriormente."
          },
          "heatmap": {
            "type": "string",
            "description": "Visualización del hallazgo en mapa de colores JET (Base64). Rojo=Mala calidad/Sospecha, Azul=Limpio.",
            "example": "iVBORw0KGgoAAA..."
          },
          "mask": {
            "type": "string",
            "description": "Máscara binaria (Blanco/Negro) que aísla los píxeles que superaron el umbral de anomalía.",
            "example": "iVBORw0KGgoAAA..."
          },
          "data": {
            "type": "object",
            "description": "Datos adicionales de contexto. Si es 'Veredicto Compuesto', contiene la imagen 'overlay' con resaltados rojos sobre el original.",
            "example": {
              "overlay": "iVBORw0KGgoAAA...",
              "software_detected": "Photoshop CC 2024",
              "motion_magnitude": 12.5
            }
          }
        }
      }
    }
  }
}

