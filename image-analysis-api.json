{
  "openapi": "3.0.3",
  "info": {
    "title": "API de Análisis Forense Multimodal (Botilito v4.0)",
    "description": "Interfaz de programación para el motor de detección de manipulación de medios digitales de Botilito. \n\n### Arquitectura\nEste servicio opera bajo un modelo **asíncrono y distribuido**:\n1. **Ingesta**: Los archivos se reciben en Base64, se calculan hashes SHA-256 para deduplicación y se almacenan en **Cloudflare R2**.\n2. **Procesamiento**: Un clúster de workers en Python procesa secuencialmente los fotogramas utilizando algoritmos de visión por computador (ELA, Ruido, Flujo Óptico) y actualiza el progreso en tiempo real.\n3. **Inteligencia Artificial**: Una capa de LLM (Generación Aumentada) interpreta los datos técnicos brutos y genera un informe narrativo de tres niveles.\n4. **Entrega**: Los resultados incluyen enlaces seguros a los activos visuales (mapas de calor, máscaras) y metadatos estructurados.",
    "version": "4.0.0",
    "contact": {
      "name": "Equipo de Ingeniería Forense Botilito",
      "url": "https://botilito.lordalexand.dev",
      "email": "soporte@botilito.dev"
    },
    "license": {
      "name": "Proprietary",
      "url": "https://botilito.lordalexand.dev/terms"
    }
  },
  "servers": [
    {
      "url": "https://mdkswlgcqsmgfmcuorxq.supabase.co/functions/v1/image-analysis",
      "description": "Entorno de Producción (Supabase Edge Function)"
    }
  ],
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Requiere un Token de Acceso (JWT) válido emitido por el sistema de autenticación de Supabase. Debe enviarse en la cabecera `Authorization`."
      }
    },
    "schemas": {
      "SubmissionRequest": {
        "type": "object",
        "description": "Objeto de solicitud para iniciar un nuevo análisis.",
        "required": [
          "image_base64"
        ],
        "properties": {
          "image_base64": {
            "type": "string",
            "format": "base64",
            "description": "El archivo multimedia a analizar, codificado completamente en cadena Base64. \n\n**Formatos Soportados:**\n- **Imágenes:** JPEG, PNG, WEBP, TIFF.\n- **Video:** MP4, MOV, AVI (Se analizarán fotogramas clave mediante muestreo adaptativo).\n\n**Restricciones:**\n- Tamaño máximo del payload: 50MB.\n- Se recomienda incluir el prefijo Data URI (ej: `data:image/jpeg;base64,...`), aunque el sistema puede procesar cadenas puras.",
            "example": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..."
          }
        }
      },
      "SubmissionResponse": {
        "type": "object",
        "description": "Respuesta inmediata tras la recepción del archivo.",
        "properties": {
          "job_id": {
            "type": "string",
            "format": "uuid",
            "description": "Identificador único universal (UUID v4) asignado al trabajo de análisis. Este ID es la llave para consultar posteriormente el endpoint de estado.",
            "example": "a1b2c3d4-e5f6-7890-1234-56789abcdef0"
          },
          "status": {
            "type": "string",
            "enum": [
              "processing",
              "completed"
            ],
            "description": "Estado inicial del trabajo:\n- `processing`: El archivo es nuevo y ha sido enviado a la cola de procesamiento.\n- `completed`: El archivo ya había sido analizado previamente (coincidencia de Hash) y los resultados están disponibles inmediatamente.",
            "example": "processing"
          },
          "message": {
            "type": "string",
            "description": "Mensaje legible para el usuario indicando el resultado de la operación de envío.",
            "example": "Análisis iniciado exitosamente."
          }
        }
      },
      "JobStatusResponse": {
        "type": "object",
        "description": "Objeto dinámico que representa el estado actual del análisis. La estructura de los campos disponibles varía según el valor de `status`.",
        "required": [
          "id",
          "status"
        ],
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "El ID del trabajo consultado.",
            "example": "a1b2c3d4-e5f6-7890-1234-56789abcdef0"
          },
          "status": {
            "type": "string",
            "enum": [
              "pending",
              "processing",
              "completed",
              "failed"
            ],
            "description": "Estado actual del ciclo de vida del análisis:\n- `pending`: En espera de recursos libres.\n- `processing`: El worker de Python está ejecutando algoritmos activamente.\n- `completed`: Análisis finalizado, resultados disponibles.\n- `failed`: Ocurrió un error irrecuperable durante el proceso."
          },
          "progress": {
            "$ref": "#/components/schemas/ProgressData",
            "description": "Objeto de telemetría en tiempo real. **Solo presente cuando status es 'processing' o 'pending'**."
          },
          "result": {
            "$ref": "#/components/schemas/AnalysisResult",
            "description": "Resultados forenses completos e informe de IA. **Solo presente cuando status es 'completed'**."
          },
          "error": {
            "type": "string",
            "nullable": true,
            "description": "Descripción técnica detallada del error (Stack Trace o mensaje de excepción). **Solo presente cuando status es 'failed'**.",
            "example": "RuntimeError: FFmpeg failed to extract frame 12 due to corrupt video stream."
          }
        }
      },
      "ProgressData": {
        "type": "object",
        "description": "Información granular sobre el avance del análisis en el backend.",
        "properties": {
          "step": {
            "type": "string",
            "description": "Etiqueta legible del paso actual que se está ejecutando.",
            "example": "Ejecutando Algoritmo: Flujo Óptico (Frame 3/10)"
          },
          "percent": {
            "type": "integer",
            "format": "int32",
            "minimum": 0,
            "maximum": 100,
            "description": "Estimación porcentual de completitud del trabajo total.",
            "example": 45
          },
          "logs": {
            "type": "array",
            "description": "Lista cronológica de los últimos eventos registrados por el sistema para depuración o feedback visual.",
            "items": {
              "type": "string",
              "description": "Mensaje de log con marca de tiempo."
            },
            "example": [
              "[10:05:01] Archivo descargado de R2 (15MB)",
              "[10:05:02] Metadatos de video extraídos",
              "[10:05:05] Iniciando análisis de ELA"
            ]
          }
        }
      },
      "AnalysisResult": {
        "type": "object",
        "description": "Estructura principal de resultados. Contiene el resumen ejecutivo, el reporte de inteligencia artificial y los detalles técnicos cuadro a cuadro.",
        "properties": {
          "summary": {
            "type": "object",
            "description": "Resumen métrico de alto nivel.",
            "properties": {
              "global_score": {
                "type": "number",
                "format": "float",
                "minimum": 0,
                "maximum": 1,
                "description": "Puntaje máximo consolidado de anomalía detectado en todo el archivo. Representa la probabilidad matemática de manipulación.",
                "example": 0.98
              },
              "global_verdict": {
                "type": "string",
                "enum": [
                  "CLEAN",
                  "SUSPICIOUS",
                  "TAMPERED"
                ],
                "description": "Etiqueta categórica derivada del `global_score`:\n- `CLEAN`: Score < 0.4\n- `SUSPICIOUS`: 0.4 <= Score <= 0.65\n- `TAMPERED`: Score > 0.65",
                "example": "TAMPERED"
              },
              "frames_analyzed": {
                "type": "integer",
                "description": "Cantidad total de fotogramas procesados individualmente.",
                "example": 3
              }
            }
          },
          "ai_analysis": {
            "$ref": "#/components/schemas/AIAnalysisReport",
            "description": "Informe narrativo generado por un Modelo de Lenguaje (LLM). Interpreta los mapas de calor y scores para explicar *por qué* el contenido parece falso."
          },
          "details": {
            "type": "array",
            "description": "Vector temporal de análisis. Contiene un objeto por cada fotograma muestreado.",
            "items": {
              "$ref": "#/components/schemas/FrameAnalysis"
            }
          }
        }
      },
      "AIAnalysisReport": {
        "type": "object",
        "description": "Informe estructurado generado por IA que traduce datos técnicos a lenguaje natural.",
        "properties": {
          "level_1_analysis": {
            "type": "array",
            "description": "Nivel 1: Desglose granular. La IA analiza cada algoritmo individualmente.",
            "items": {
              "type": "object",
              "properties": {
                "algorithm": {
                  "type": "string",
                  "description": "Nombre del algoritmo evaluado.",
                  "example": "ELA (Error Level Analysis)"
                },
                "significance_score": {
                  "type": "number",
                  "format": "float",
                  "description": "Relevancia asignada por la IA a este hallazgo específico (0-1).",
                  "example": 0.85
                },
                "interpretation": {
                  "type": "string",
                  "description": "Interpretación textual del hallazgo.",
                  "example": "Se observan bloques de alta compresión en la zona del rostro que no coinciden con el fondo, sugiriendo un montaje."
                }
              }
            }
          },
          "level_2_integration": {
            "type": "object",
            "description": "Nivel 2: Análisis Holístico. La IA busca correlaciones entre diferentes algoritmos.",
            "properties": {
              "consistency_score": {
                "type": "number",
                "format": "float",
                "description": "Puntaje de coherencia entre pruebas (0-1). Un puntaje alto indica que múltiples pruebas apuntan a la misma zona.",
                "example": 0.92
              },
              "tampering_type": {
                "type": "string",
                "enum": [
                  "Global (Filtros/Recompresión)",
                  "Local (Inserción/Clonado/Borrado)",
                  "Inexistente"
                ],
                "description": "Clasificación del tipo de manipulación detectada.",
                "example": "Local (Inserción/Clonado/Borrado)"
              },
              "synthesis_notes": {
                "type": "string",
                "description": "Nota de síntesis explicando la correlación hallada.",
                "example": "La detección de ruido y ELA presentan anomalías superpuestas en el cuadrante superior derecho, lo que aumenta drásticamente la certeza de manipulación."
              }
            }
          },
          "level_3_verdict": {
            "type": "object",
            "description": "Nivel 3: Conclusión. Veredicto final dirigido al usuario final.",
            "properties": {
              "manipulation_probability": {
                "type": "number",
                "format": "float",
                "description": "Probabilidad final calculada por la IA en porcentaje (0-100).",
                "example": 95.5
              },
              "final_label": {
                "type": "string",
                "description": "Etiqueta final legible.",
                "example": "Alta Sospecha de Manipulación"
              },
              "user_explanation": {
                "type": "string",
                "description": "Párrafo explicativo detallado y educativo en español, diseñado para ser mostrado en la interfaz de usuario.",
                "example": "El análisis forense indica con una probabilidad del 95.5% que esta imagen ha sido manipulada. Se detectaron discrepancias significativas en los niveles de compresión (ELA) y en el patrón de ruido del sensor en el área del sujeto principal, lo que es característico de objetos insertados digitalmente desde otra fuente."
              }
            }
          }
        }
      },
      "FrameAnalysis": {
        "type": "object",
        "description": "Contenedor de datos para un momento específico en el tiempo (Frame).",
        "properties": {
          "frame_index": {
            "type": "integer",
            "description": "El índice secuencial del fotograma dentro del video (0-based). Para imágenes estáticas, siempre es 0.",
            "example": 24
          },
          "original_frame": {
            "type": "string",
            "format": "uri",
            "description": "URL pública (HTTPS) apuntando al almacenamiento R2. Contiene la imagen original exacta que fue analizada en este paso. Fundamental para comparar con los mapas de calor.",
            "example": "https://pub.r2.dev/jobs/a1b2.../frame_24/source.jpg"
          },
          "max_score": {
            "type": "number",
            "format": "float",
            "description": "El valor máximo de anomalía encontrado en este fotograma específico, considerando todos los algoritmos ejecutados.",
            "example": 0.88
          },
          "insights": {
            "type": "array",
            "description": "Colección de hallazgos (insights) generados por los diferentes motores de detección para este fotograma.",
            "items": {
              "$ref": "#/components/schemas/Insight"
            }
          }
        }
      },
      "Insight": {
        "type": "object",
        "description": "Unidad atómica de hallazgo forense. Es polimórfico: su estructura de datos (`data`) y visualización dependen del campo `type`.",
        "required": [
          "algo",
          "type",
          "value",
          "description"
        ],
        "properties": {
          "algo": {
            "type": "string",
            "description": "Identificador interno del algoritmo ejecutado.",
            "enum": [
              "ELA",
              "NOISE",
              "SLIC",
              "GHOSTING",
              "CLONE",
              "MOTION",
              "METADATA",
              "Veredicto Compuesto"
            ],
            "example": "ELA"
          },
          "type": {
            "type": "string",
            "enum": [
              "classic_algo",
              "metadata",
              "ai_model"
            ],
            "description": "Discriminador de tipo para la interfaz de usuario:\n- `classic_algo`: Debe mostrarse como una capa visual (heatmap/mask) sobre la imagen original.\n- `metadata`: Debe mostrarse como una tabla de datos clave-valor.\n- `ai_model`: Datos probabilísticos complejos.",
            "example": "classic_algo"
          },
          "value": {
            "oneOf": [
              {
                "type": "number",
                "format": "float",
                "description": "Para algoritmos: puntaje normalizado de anomalía (0.0 - 1.0)."
              },
              {
                "type": "string",
                "description": "Para metadatos: Resumen textual del hallazgo (ej: 'Software Detectado')."
              }
            ],
            "example": 0.95
          },
          "description": {
            "type": "string",
            "description": "Texto explicativo en español sobre qué hace este algoritmo y cómo interpretar el resultado.",
            "example": "Detecta áreas de la imagen que fueron guardadas con un nivel de compresión diferente al resto."
          },
          "heatmap": {
            "type": "string",
            "format": "uri",
            "nullable": true,
            "description": "URL pública (R2) a la imagen del mapa de calor. Renderizada con mapa de colores JET (Azul=Bajo, Rojo=Alto). Útil para visualización intuitiva.",
            "example": "https://pub.r2.dev/jobs/uuid/frame_24/ela_heatmap.jpg"
          },
          "mask": {
            "type": "string",
            "format": "uri",
            "nullable": true,
            "description": "URL pública (R2) a la máscara binaria (Blanco y Negro). Útil para superposición programática o cálculo de áreas afectadas.",
            "example": "https://pub.r2.dev/jobs/uuid/frame_24/ela_mask.jpg"
          },
          "data": {
            "type": "object",
            "nullable": true,
            "description": "Objeto flexible para datos crudos adicionales.\n- Si `algo`='Veredicto Compuesto', contiene la propiedad `overlay` (URL a la imagen compuesta final).\n- Si `type`='metadata', contiene el diccionario de tags EXIF.",
            "example": {
              "overlay": "https://pub.r2.dev/jobs/uuid/frame_24/compound_overlay.jpg"
            }
          }
        }
      }
    }
  }
}

