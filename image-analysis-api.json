{
  "openapi": "3.0.3",
  "info": {
    "title": "Forensic Media Analysis API",
    "version": "2.1.0",
    "description": "API for detecting digital forgeries in images and videos. Features chunked uploads for large files, multi-algorithm analysis (ELA, Noise, SLIC, Copy-Move), and LLM-based forensic reporting.",
    "contact": {
      "name": "API Support"
    }
  },
  "servers": [
    {
      "url": "https://mdkswlgcqsmgfmcuorxq.supabase.co/functions/v1/image-analysis",
      "description": "Supabase Edge Function Gateway"
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "properties": {
          "error": { "type": "string" }
        }
      },
      "UploadInitRequest": {
        "type": "object",
        "required": ["action", "filename", "total_chunks", "total_size", "file_hash"],
        "properties": {
          "action": { "type": "string", "enum": ["init"] },
          "filename": { "type": "string", "example": "evidence_video.mp4" },
          "total_chunks": { "type": "integer", "example": 12 },
          "total_size": { "type": "integer", "description": "Total bytes", "example": 52428800 },
          "file_hash": { "type": "string", "description": "SHA-256 hash of the complete binary file", "example": "a591a6d40bf420404a011733cfb7b190d62c65bf0bcda32b57b277d9ad9f146e" },
          "use_cache": { "type": "boolean", "default": true, "description": "If true, returns existing result if hash matches." }
        }
      },
      "UploadChunkRequestJSON": {
        "type": "object",
        "description": "Use this for small chunks or non-browser clients. For efficiency, use multipart/form-data instead.",
        "required": ["action", "upload_id", "chunk_index", "chunk_b64"],
        "properties": {
          "action": { "type": "string", "enum": ["chunk"] },
          "upload_id": { "type": "string", "format": "uuid" },
          "chunk_index": { "type": "integer", "example": 0 },
          "chunk_b64": { "type": "string", "description": "Base64 encoded chunk data (Max 5MB)" }
        }
      },
      "UploadFinishRequest": {
        "type": "object",
        "required": ["action", "upload_id", "file_hash"],
        "properties": {
          "action": { "type": "string", "enum": ["finish"] },
          "upload_id": { "type": "string", "format": "uuid" },
          "file_hash": { "type": "string", "description": "Must match the hash sent in init for integrity check." }
        }
      },
      "ForensicResult": {
        "type": "object",
        "properties": {
          "summary": {
            "type": "object",
            "properties": {
              "global_score": { "type": "number", "format": "float", "example": 0.89 },
              "global_verdict": { "type": "string", "enum": ["CLEAN", "SUSPICIOUS", "TAMPERED"], "example": "TAMPERED" },
              "frames_analyzed": { "type": "integer", "example": 5 }
            }
          },
          "details": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/FrameAnalysis" }
          },
          "ai_analysis": { "$ref": "#/components/schemas/AIAnalysis" }
        }
      },
      "FrameAnalysis": {
        "type": "object",
        "properties": {
          "frame_index": { "type": "integer", "example": 0 },
          "max_score": { "type": "number", "example": 0.89 },
          "original_frame": { "type": "string", "format": "uri", "description": "URL to the source image/frame on R2" },
          "insights": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/Insight" }
          }
        }
      },
      "Insight": {
        "type": "object",
        "description": "Detailed result from a specific algorithm",
        "properties": {
          "algo": {
            "type": "string",
            "enum": ["ELA", "NOISE", "SLIC", "GHOSTING", "CLONE", "TEMPORAL", "METADATA"],
            "example": "ELA"
          },
          "type": { "type": "string", "enum": ["classic_algo", "metadata"], "example": "classic_algo" },
          "value": {
            "oneOf": [{ "type": "number" }, { "type": "string" }],
            "description": "The score (0.0-1.0) or metadata value",
            "example": 0.85
          },
          "description": { "type": "string", "example": "High frequency error rate suggests re-compression." },
          "heatmap": { "type": "string", "format": "uri", "description": "Visual heatmap URL (Jet colormap)" },
          "mask": { "type": "string", "format": "uri", "description": "Binary mask URL (White = Tampered)" },
          "data": { "type": "object", "description": "Optional raw data (e.g., EXIF tags)" }
        }
      },
      "AIAnalysis": {
        "type": "object",
        "description": "Generated by LLM based on technical signals",
        "properties": {
          "level_3_verdict": {
            "type": "object",
            "properties": {
              "user_explanation": { "type": "string", "example": "The image shows strong signs of manipulation in the upper right corner." },
              "confidence_score": { "type": "number", "example": 0.92 }
            }
          },
          "level_2_integration": {
             "type": "object",
             "description": "Technical correlation analysis"
          }
        }
      }
    }
  },
  "security": [
    { "bearerAuth": [] }
  ],
  "paths": {
    "/upload_session": {
      "post": {
        "summary": "Orchestrate Upload Session",
        "description": "Handles Initialization, Chunk Uploading, and Finalization. \n\n**Note for Chunks:** You can send `application/json` (Base64) OR `multipart/form-data` (Binary). Binary is recommended for performance.",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "oneOf": [
                  { "$ref": "#/components/schemas/UploadInitRequest" },
                  { "$ref": "#/components/schemas/UploadChunkRequestJSON" },
                  { "$ref": "#/components/schemas/UploadFinishRequest" }
                ]
              }
            },
            "multipart/form-data": {
              "schema": {
                "type": "object",
                "properties": {
                  "action": { "type": "string", "enum": ["chunk"] },
                  "upload_id": { "type": "string", "format": "uuid" },
                  "chunk_index": { "type": "integer" },
                  "chunk_data": { "type": "string", "format": "binary" }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Action Successful",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": { "type": "string", "example": "ready" },
                    "upload_id": { "type": "string", "format": "uuid" },
                    "job_id": { "type": "string", "format": "uuid", "description": "Returned only on 'finish' action" }
                  }
                }
              }
            }
          },
          "400": { "description": "Integrity Check Failed (Hash Mismatch)" }
        }
      }
    },
    "/status/{jobId}": {
      "get": {
        "summary": "Poll Job Status",
        "description": "Check progress. When status is 'completed', returns full forensic report.",
        "parameters": [
          { "name": "jobId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "200": {
            "description": "Status or Result",
            "content": {
              "application/json": {
                "schema": {
                   "oneOf": [
                     {
                       "type": "object",
                       "properties": {
                         "id": { "type": "string" },
                         "status": { "type": "string", "example": "processing" },
                         "progress": {
                           "type": "object",
                           "properties": {
                             "step": { "type": "string" },
                             "percent": { "type": "integer" }
                           }
                         }
                       }
                     },
                     {
                       "allOf": [
                         {
                           "type": "object",
                           "properties": {
                             "status": { "type": "string", "example": "completed" },
                             "result": { "$ref": "#/components/schemas/ForensicResult" }
                           }
                         }
                       ]
                     }
                   ]
                }
              }
            }
          }
        }
      }
    }
  }
}
