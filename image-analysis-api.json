{
  "openapi": "3.0.3",
  "info": {
    "title": "Forensic Media Analysis API",
    "version": "2.3.0",
    "description": "API for detecting digital forgeries. Features chunked uploads, video time-stamping, original file archiving, and Spanish-localized LLM analysis.",
    "contact": {
      "name": "API Support"
    }
  },
  "servers": [
    {
      "url": "https://your-project.supabase.co/functions/v1/analysis",
      "description": "Supabase Edge Function Gateway"
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase Auth Token"
      }
    },
    "schemas": {
      "UploadInitRequest": {
        "type": "object",
        "required": ["action", "filename", "total_chunks", "total_size", "file_hash"],
        "properties": {
          "action": { "type": "string", "enum": ["init"] },
          "filename": { "type": "string", "example": "evidence.mp4" },
          "total_chunks": { "type": "integer", "example": 12 },
          "total_size": { "type": "integer", "example": 52428800 },
          "file_hash": { "type": "string", "description": "SHA-256 hash of the binary file", "example": "a591a6d4..." },
          "use_cache": { "type": "boolean", "default": true }
        }
      },
      "UploadChunkRequestMultipart": {
        "type": "object",
        "description": "Send as multipart/form-data",
        "properties": {
          "action": { "type": "string", "enum": ["chunk"] },
          "upload_id": { "type": "string", "format": "uuid" },
          "chunk_index": { "type": "integer" },
          "chunk_data": { "type": "string", "format": "binary" }
        }
      },
      "UploadFinishRequest": {
        "type": "object",
        "required": ["action", "upload_id", "file_hash"],
        "properties": {
          "action": { "type": "string", "enum": ["finish"] },
          "upload_id": { "type": "string", "format": "uuid" },
          "file_hash": { "type": "string" }
        }
      },
      "ForensicResult": {
        "type": "object",
        "properties": {
          "summary": {
            "type": "object",
            "properties": {
              "global_score": { "type": "number", "example": 0.98 },
              "global_verdict": { "type": "string", "enum": ["CLEAN", "SUSPICIOUS", "TAMPERED"], "example": "TAMPERED" },
              "frames_analyzed": { "type": "integer", "example": 5 },
              "original_video": { 
                "type": "string", 
                "format": "uri", 
                "nullable": true,
                "description": "If input was video, this is the R2 URL to the full source file."
              }
            }
          },
          "details": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/FrameAnalysis" }
          },
          "ai_analysis": {
            "$ref": "#/components/schemas/AIAnalysis"
          }
        }
      },
      "FrameAnalysis": {
        "type": "object",
        "properties": {
          "frame_index": { "type": "integer", "example": 0 },
          "timestamp": { 
            "type": "string", 
            "example": "00:00:05", 
            "description": "Time position of this frame in the source video." 
          },
          "max_score": { "type": "number", "example": 0.98 },
          "original_frame": { "type": "string", "format": "uri", "description": "The specific extracted frame image." },
          "insights": {
            "type": "array",
            "items": { "$ref": "#/components/schemas/Insight" }
          }
        }
      },
      "Insight": {
        "type": "object",
        "properties": {
          "algo": { "type": "string", "example": "ELA" },
          "type": { "type": "string", "enum": ["classic_algo", "metadata"], "example": "classic_algo" },
          "value": { "oneOf": [{ "type": "number" }, { "type": "string" }], "example": 0.85 },
          "description": { "type": "string" },
          "heatmap": { "type": "string", "format": "uri" },
          "mask": { "type": "string", "format": "uri" },
          "data": { "type": "object", "description": "Raw metadata or overlay URLs" }
        }
      },
      "AIAnalysis": {
        "type": "object",
        "properties": {
          "level_3_verdict": {
            "type": "object",
            "properties": {
              "user_explanation": { "type": "string" },
              "confidence_score": { "type": "number" }
            }
          },
          "level_2_integration": { "type": "object" }
        }
      }
    }
  },
  "security": [
    { "bearerAuth": [] }
  ],
  "paths": {
    "/upload_session": {
      "post": {
        "summary": "Orchestrate Upload",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "oneOf": [
                  { "$ref": "#/components/schemas/UploadInitRequest" },
                  { "$ref": "#/components/schemas/UploadFinishRequest" }
                ]
              }
            },
            "multipart/form-data": {
              "schema": { "$ref": "#/components/schemas/UploadChunkRequestMultipart" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Success",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "status": { "type": "string", "example": "ready" },
                    "upload_id": { "type": "string" },
                    "job_id": { "type": "string" }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/status/{jobId}": {
      "get": {
        "summary": "Get Results",
        "parameters": [{ "name": "jobId", "in": "path", "required": true, "schema": { "type": "string" } }],
        "responses": {
          "200": {
            "description": "Result",
            "content": {
              "application/json": {
                "schema": {
                  "oneOf": [
                    { 
                      "type": "object", 
                      "properties": { 
                        "status": { "type": "string", "example": "processing" },
                        "progress": { "type": "object" }
                      } 
                    },
                    { 
                      "type": "object", 
                      "properties": { 
                        "status": { "type": "string", "example": "completed" },
                        "result": { "$ref": "#/components/schemas/ForensicResult" }
                      } 
                    }
                  ]
                }
              }
            }
          }
        }
      }
    }
  }
}