{
  "openapi": "3.0.3",
  "info": {
    "title": "Botilito User Profile API",
    "description": "API for managing user identities, demographics, and reputation stats.\n\n### Gamification & Rewards\nThis API implements a **One-Time Reward** system for profile completion.\n- **Trigger:** When a user updates their profile via `PUT /profile`.\n- **Condition:** If the user provides `nombre_completo`, `departamento`, and `ciudad` for the first time.\n- **Reward:** The system awards **+50 XP (Puntos de Inmunización)** and sets the internal flag `profile_rewarded` to true.\n\n### Authentication\nAll endpoints require a valid Supabase JWT in the `Authorization` header.",
    "version": "1.2.0",
    "contact": {
      "name": "API Support",
      "email": "dev@botilito.dev"
    }
  },
  "servers": [
    {
      "url": "https://mdkswlgcqsmgfmcuorxq.supabase.co/functions/v1/profile",
      "description": "Production Edge Function"
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Supabase User Token."
      }
    },
    "schemas": {
      "UserProfile": {
        "type": "object",
        "description": "Public profile information for a user.",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "Unique user ID (linked to auth.users).",
            "example": "a1b2c3d4-e5f6-7890-1234-567890abcdef"
          },
          "email": {
            "type": "string",
            "format": "email",
            "example": "usuario@ejemplo.com"
          },
          "nombre_completo": {
            "type": "string",
            "nullable": true,
            "description": "Full display name. Required for 'Profile Complete' badge.",
            "example": "Juan Pérez"
          },
          "departamento": {
            "type": "string",
            "nullable": true,
            "description": "Geographic department (e.g., Cundinamarca). Required for rewards.",
            "example": "Bogotá D.C."
          },
          "ciudad": {
            "type": "string",
            "nullable": true,
            "description": "City of residence. Required for rewards.",
            "example": "Bogotá"
          },
          "role": {
            "type": "string",
            "enum": [
              "cibernauta",
              "epidemiologo",
              "director"
            ],
            "description": "Current system role determining RBAC permissions.",
            "example": "cibernauta"
          },
          "xp": {
            "type": "integer",
            "description": "Total 'Puntos de Inmunización' (PI) earned.",
            "example": 150
          },
          "reputation": {
            "type": "number",
            "description": "Calculated reliability score based on voting consensus history.",
            "example": 4.5
          },
          "current_streak": {
            "type": "integer",
            "description": "Consecutive days of activity.",
            "example": 5
          },
          "profile_rewarded": {
            "type": "boolean",
            "description": "Internal flag. If true, the +50 XP reward has already been claimed."
          },
          "avatar_url": {
            "type": "string",
            "format": "uri",
            "nullable": true
          }
        }
      },
      "UpdateProfileRequest": {
        "type": "object",
        "description": "Fields to update. Providing missing demographic fields triggers the Gamification Engine.",
        "properties": {
          "nombre_completo": {
            "type": "string",
            "minLength": 3
          },
          "departamento": {
            "type": "string"
          },
          "ciudad": {
            "type": "string"
          },
          "avatar_url": {
            "type": "string",
            "format": "uri"
          }
        }
      },
      "UpdateResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "data": {
            "$ref": "#/components/schemas/UserProfile"
          },
          "reward_awarded": {
            "type": "boolean",
            "description": "True if this specific update triggered the +50 XP bonus.",
            "example": true
          },
          "message": {
            "type": "string",
            "example": "Profile updated successfully. +50 XP Awarded!"
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "example": "Database Error"
          },
          "details": {
            "type": "string"
          }
        }
      }
    }
  },
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "paths": {
    "/": {
      "get": {
        "summary": "Get My Profile",
        "description": "Retrieves the profile of the authenticated user based on the JWT token.",
        "responses": {
          "200": {
            "description": "Profile Data",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserProfile"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized"
          },
          "404": {
            "description": "Profile not found (User needs to be initialized)"
          }
        }
      },
      "put": {
        "summary": "Update Profile",
        "description": "Updates demographic and display information. \n\n**Gamification Logic:**\nIf the user fills in `nombre_completo`, `departamento`, and `ciudad` for the first time, the backend automatically:\n1. Awards **+50 XP**.\n2. Sets `profile_rewarded` to `true`.\n3. Returns `reward_awarded: true` in the response.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateProfileRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Profile Updated",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UpdateResponse"
                }
              }
            }
          },
          "400": {
            "description": "Validation Error"
          },
          "401": {
            "description": "Unauthorized"
          }
        }
      }
    }
  }
}